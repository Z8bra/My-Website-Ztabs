<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Assistant - Z Tabs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .chat-layout {
            display: flex;
            height: calc(100vh - 180px);
            max-width: 1400px;
            margin: 20px auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .chat-sidebar {
            width: 300px;
            border-right: 1px solid #e0e0e0;
            background: #f9f9f9;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chat-item {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item:hover, .chat-item.active {
            background: #ff8c00;
            color: white;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #ff8c00;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #e67e00;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            background: #ff8c00;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            margin: 0;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            margin-bottom: 5px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .user-message {
            background: #ff8c00;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background: #f5f5f5;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            display: flex;
            padding: 15px;
            background: #fff;
            border-top: 1px solid #eee;
            gap: 10px;
        }
        
        #chatInput {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            outline: none;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        #chatInput:focus {
            border-color: #ff8c00;
        }
        
        #sendButton {
            padding: 0 25px;
            background: #ff8c00;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        #sendButton:hover {
            background: #e67e00;
        }
        
        .typing-indicator {
            display: none;
            padding: 12px 18px;
            background: #f5f5f5;
            border-radius: 18px;
            margin: 5px 0 15px 0;
            width: fit-content;
            font-style: italic;
            color: #666;
            align-self: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .suggestion-chip {
            display: inline-block;
            background: #ffeedd;
            color: #e67e00;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            border: 1px solid #ffd8b2;
        }
        
        .suggestion-chip:hover {
            background: #ffd8b2;
            transform: translateY(-2px);
        }

        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            padding: 10px 0;
        }

        .no-chats {
            color: #999;
            text-align: center;
            margin-top: 50px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .chat-layout {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                max-height: 200px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Z Tabs</h1>
        <div class="header-actions">
            <input type="search" class="search-input" id="globalSearch" placeholder="Search tabs, playlists, courses..."/>
            <div class="dropdown">
                <button class="dropdown-toggle">Menu ‚ñæ</button>
                <div class="dropdown-menu">
                    <a href="index.html">Home</a>
                    <a href="Tabs.html">Tabs</a>
                    <a href="Playlist.html" data-auth style="display: none;">Playlists</a>
                    <a href="Courses.html" data-auth style="display: none;">Courses</a>
                    <a href="Chats.html">Chats</a>
                    <a href="signin.html" id="signinLink">Sign In</a>
                    <a href="#" id="signoutLink" style="display: none;" onclick="signOut()">Sign Out</a>
                </div>
            </div>
        </div>
    </header>

    <section class="page-hero">
        <h2>Music Assistant</h2>
        <p>Your AI-powered music companion for tabs, theory, and song analysis.</p>
    </section>

    <div class="chat-layout">
        <div class="chat-sidebar">
            <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
            <div id="chatList">
                <!-- Chat history will be populated here -->
                <div class="no-chats">No chats yet</div>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-header">
                <h3 class="chat-title" id="chatTitle">New Chat</h3>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <strong>üéµ Music Assistant</strong>
                    <p>Hello! I'm your music assistant. I can help you with:</p>
                    <ul>
                        <li>Finding and analyzing guitar tabs and chords</li>
                        <li>Explaining music theory concepts in depth</li>
                        <li>Interpreting song meanings and lyrics</li>
                        <li>Providing practice routines and techniques</li>
                        <li>Discussing music history and genres</li>
                    </ul>
                    <p>What would you like to know about music today?</p>
                    
                    <div class="suggestions-container">
                        <div class="suggestion-chip">Guitar tabs for Hotel California</div>
                        <div class="suggestion-chip">Explain the circle of fifths</div>
                        <div class="suggestion-chip">Song meaning of Bohemian Rhapsody</div>
                        <div class="suggestion-chip">Best practice routine for beginners</div>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span class="dot">‚Ä¢</span>
                <span class="dot">‚Ä¢</span>
                <span class="dot">‚Ä¢</span>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask me anything about music..." autofocus>
                <button id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const typingIndicator = document.getElementById('typingIndicator');
            const newChatBtn = document.getElementById('newChatBtn');
            const chatList = document.getElementById('chatList');
            const chatTitle = document.getElementById('chatTitle');
            
            let currentChatId = null;
            let chats = JSON.parse(localStorage.getItem('musicChats')) || [];
            let currentChatMessages = [];
            
            // Check if user is signed in
            function isUserSignedIn() {
                // This should be replaced with your actual auth check
                return localStorage.getItem('user') !== null;
            }
            
            // Check message limit
            function checkMessageLimit() {
                if (isUserSignedIn()) return true;
                const messageCount = Object.values(chats).reduce((count, chat) => count + chat.messages.filter(m => m.sender === 'user').length, 0);
                return messageCount < 10; // 10 message limit for non-signed-in users
            }
            
            // Show sign in prompt
            function showSignInPrompt() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'signin-prompt';
                messageDiv.innerHTML = `
                    <p>You've reached the message limit for non-signed-in users.</p>
                    <button id="signInButton">Sign In to Continue</button>
                    <p>Already have an account? <a href="#" id="loginLink">Log In</a></p>
                `;
                chatMessages.appendChild(messageDiv);
                
                // Add event listeners
                document.getElementById('signInButton')?.addEventListener('click', () => {
                    // Replace with your sign-in logic
                    window.location.href = 'signin.html';
                });
                
                document.getElementById('loginLink')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Replace with your login logic
                    window.location.href = 'login.html';
                });
            }
            
            // Initialize the chat
            function initChat() {
                // Make sure chats is an object
                if (!chats || typeof chats !== 'object') {
                    chats = {};
                    saveChats();
                }
                
                renderChatList();
                
                // If no chats or chats is empty, create a new one
                if (Object.keys(chats).length === 0) {
                    createNewChat();
                } else {
                    // Load the most recent chat
                    const chatIds = Object.keys(chats);
                    loadChat(chatIds[chatIds.length - 1]);
                }
                
                // Set up event listeners
                newChatBtn.addEventListener('click', createNewChat);
                
                // Set up send button and enter key
                sendButton.addEventListener('click', handleSendMessage);
                
                // Handle Enter key in input
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
                
                // Set up suggestion chips
                setupSuggestionChips();
            }
            
            // Handle sending a message
            function handleSendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Check message limit for non-signed-in users
                if (!checkMessageLimit() && !isUserSignedIn()) {
                    showSignInPrompt();
                    return;
                }
                
                // Add user message
                addMessageToChat(message, true);
                chatInput.value = '';
                
                // Show typing indicator
                showTypingIndicator(true);
                
                // Simulate bot response after a short delay
                setTimeout(() => {
                    showTypingIndicator(false);
                    const response = getBotResponse(message);
                    addMessageToChat(response, false);
                }, 1000);
            }
            
            // Set up suggestion chips
            function setupSuggestionChips() {
                document.querySelectorAll('.suggestion-chip').forEach(chip => {
                    // Remove any existing event listeners to prevent duplicates
                    const newChip = chip.cloneNode(true);
                    chip.parentNode.replaceChild(newChip, chip);
                    
                    newChip.addEventListener('click', () => {
                        const message = newChip.textContent.trim();
                        if (message) {
                            if (!checkMessageLimit() && !isUserSignedIn()) {
                                showSignInPrompt();
                                return;
                            }
                            
                            // Add user message
                            addMessageToChat(message, true);
                            
                            // Show typing indicator
                            showTypingIndicator(true);
                            
                            // Simulate bot response after a short delay
                            setTimeout(() => {
                                showTypingIndicator(false);
                                const response = getBotResponse(message);
                                addMessageToChat(response, false);
                            }, 1000);
                        }
                    });
                });
            }
            
            // Create a new chat
            function createNewChat() {
                const chatId = 'chat-' + Date.now();
                const newChat = {
                    id: chatId,
                    title: 'New Chat',
                    messages: [{
                        sender: 'bot',
                        content: 'Hello! How can I help you with music today?',
                        timestamp: new Date()
                    }]
                };
                
                // Initialize chats if it doesn't exist
                if (!chats || typeof chats !== 'object') {
                    chats = {};
                }
                
                chats[chatId] = newChat;
                currentChatId = chatId;
                saveChats();
                renderChatList();
                renderChat(chatId);
                chatInput.focus();
                return chatId;
            }
            
            // Load a chat by ID
            function loadChat(chatId) {
                const chat = chats[chatId];
                if (!chat) return;
                
                currentChatId = chatId;
                chatTitle.textContent = chat.title || 'New Chat';
                
                // Render messages
                chatMessages.innerHTML = '';
                chat.messages.forEach(msg => {
                    addMessageToChat(msg.content, msg.sender === 'user');
                });
                
                // Update active state in sidebar
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.chatId === chatId);
                });
            }
            
            // Render the chat list in the sidebar
            function renderChatList() {
                chatList.innerHTML = '';
                
                Object.values(chats).forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.chatId = chat.id;
                    
                    if (chat.id === currentChatId) {
                        chatItem.classList.add('active');
                    }
                    
                    chatItem.innerHTML = `
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-actions">
                            <button class="edit-chat" title="Rename chat">‚úèÔ∏è</button>
                            <button class="delete-chat" title="Delete chat">üóëÔ∏è</button>
                        </div>
                    `;
                    
                    // Load chat on title click
                    chatItem.querySelector('.chat-title').addEventListener('click', (e) => {
                        e.stopPropagation();
                        loadChat(chat.id);
                    });
                    
                    // Edit chat title
                    const editBtn = chatItem.querySelector('.edit-chat');
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const newTitle = prompt('Enter new chat title:', chat.title);
                        if (newTitle && newTitle.trim() !== '') {
                            chat.title = newTitle.trim();
                            saveChats();
                            renderChatList();
                        }
                    });
                    
                    // Delete chat
                    const deleteBtn = chatItem.querySelector('.delete-chat');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this chat?')) {
                            delete chats[chat.id];
                            saveChats();
                            if (currentChatId === chat.id) {
                                const chatIds = Object.keys(chats);
                                currentChatId = chatIds.length > 0 ? chatIds[0] : createNewChat();
                                loadChat(currentChatId);
                            }
                            renderChatList();
                        }
                    });
                    
                    chatList.appendChild(chatItem);
                });
            }
            
            // Save chats to localStorage
            function saveChats() {
                localStorage.setItem('musicChats', JSON.stringify(chats));
            }

            // Add a message to the chat UI and save it to the current chat
            function addMessageToChat(message, isUser = false) {
                // Ensure we have a valid chat
                if (!currentChatId || !chats[currentChatId]) {
                    currentChatId = createNewChat();
                }
                
                // Check message limit for non-signed-in users
                if (isUser && !isUserSignedIn()) {
                    const userMessageCount = Object.values(chats).reduce((count, chat) => 
                        count + (chat.messages || []).filter(m => m.sender === 'user').length, 0);
                    
                    if (userMessageCount >= 10) {
                        showSignInPrompt();
                        return false;
                    }
                }
                
                // Ensure messages array exists
                if (!chats[currentChatId].messages) {
                    chats[currentChatId].messages = [];
                }
                
                const messageObj = {
                    sender: isUser ? 'user' : 'bot',
                    content: message,
                    timestamp: new Date()
                };
                
                // Add to current chat
                chats[currentChatId].messages.push(messageObj);
                
                // Update chat title if it's the first user message
                if (isUser && chats[currentChatId].messages.length === 1) {
                    const title = message.length > 30 ? message.substring(0, 30) + '...' : message;
                    chats[currentChatId].title = title;
                    renderChatList();
                }
                
                // Save to localStorage
                saveChats();
                
                // Update UI
                renderChat(currentChatId);
            }
            
            // Render a chat by ID
            function renderChat(chatId) {
                const chat = chats[chatId];
                if (!chat) return;
                
                chatMessages.innerHTML = '';
                chat.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender === 'user' ? 'user-message' : 'bot-message'}`;
                    
                    // Format the message with line breaks and basic markdown
                    let formattedMessage = formatMessage(msg.content);
                    
                    // Apply golden tab formatting if it's a bot message with tabs
                    if (msg.sender === 'bot') {
                        // Check if message contains tab notation
                        if (msg.content.includes('e|--') || msg.content.includes('B|--') || 
                            msg.content.includes('G|--') || msg.content.includes('D|--') || 
                            msg.content.includes('A|--') || msg.content.includes('E|--')) {
                            formattedMessage = formatTab(msg.content);
                        }
                    }
                    
                    messageDiv.innerHTML = formattedMessage;
                    
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
            
            // Format tab with golden styling
            function formatTab(tabText) {
                if (!tabText) return '';
                const lines = tabText.split('\n');
                return lines.map(line => {
                    // Highlight fret numbers in gold
                    line = line.replace(/(\d+)/g, '<span class="tab-fret">$1</span>');
                    // Highlight string indicators
                    line = line.replace(/^([A-Za-z]\|)/, '<span class="tab-string">$1</span>');
                    // Highlight chord symbols
                    line = line.replace(/\b([A-G][#b]?m?(?:aj7?|m7?|7|dim|aug)?\b)/g, 
                                     '<span class="tab-chord">$1</span>');
                    return line;
                }).join('\n');
            }
            
            // Format message with basic markdown and line breaks
            function formatMessage(text) {
                // Convert line breaks to <br>
                let formatted = text.replace(/\n/g, '<br>');
                
                // Convert **bold** to <strong>bold</strong>
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Convert *italic* to <em>italic</em>
                formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                // Convert - list items to <li> elements
                formatted = formatted.replace(/^\s*-\s*(.*?)(<br>|$)/gm, '<li>$1</li>');
                
                // Wrap consecutive list items in <ul>
                formatted = formatted.replace(/(<li>.*?<\/li>)+/g, function(match) {
                    return '<ul>' + match + '</ul>';
                });
                
                return formatted;
            }

            function showTypingIndicator(show) {
                typingIndicator.style.display = show ? 'flex' : 'none';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Common chord progressions by genre
            const commonProgressions = {
                'pop': [
                    'I - V - vi - IV',
                    'vi - IV - I - V',
                    'I - IV - V - IV',
                    'I - V - vi - iii - IV - I - IV - V'
                ],
                'rock': [
                    'I - IV - V',
                    'I - V - vi - IV',
                    'e|-----------------0-0-0-0-0-0-0-0-|\nB|-----------------1-1-1-1-1-1-1-1-|\nG|-----------------2-2-2-2-2-2-2-2-|\nD|-----------------2-2-2-2-2-2-2-2-|\nA|-----------------0-0-0-0-0-0-0-0-|\nE|--0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-|',
                    'e|-----------------0-0-0-0-0-0-0-0-|\nB|-----------------1-1-1-1-1-1-1-1-|\nG|-----------------2-2-2-2-2-2-2-2-|\nD|-----------------2-2-2-2-2-2-2-2-|\nA|-----------------0-0-0-0-0-0-0-0-|\nE|--0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-|'
                ],
                'blues': [
                    'I - I - I - I - IV - IV - I - I - V - IV - I - V',
                    'I - IV - I - V - IV - I',
                    'e|-----------------|\nB|-----------------|\nG|-----------------|\nD|-----------------|\nA|--5-5-5-5-5-5-5-5-|\nE|--3-3-3-3-5-5-5-5-|',
                    'e|-----------------|\nB|-----------------|\nG|-----------------|\nD|--5-5-5-5-7-7-7-7-|\nA|--5-5-5-5-7-7-7-7-|\nE|--3-3-3-3-5-5-5-5-|'
                ],
                'jazz': [
                    'ii - V - I',
                    'I - vi - ii - V',
                    'iii - vi - ii - V - I',
                    'e|-----------------|\nB|-----------------|\nG|--4-6-7-9-11-9-7-6-|\nD|-----------------|\nA|-----------------|\nE|-----------------|',
                    'e|-----------------|\nB|--1-3-5-6-5-3-1---|\nG|-----------------|\nD|-----------------|\nA|-----------------|\nE|-----------------|'
                ]
            };

            // Common song structures
            const songStructures = {
                'pop': 'Verse - Pre-Chorus - Chorus - Verse - Pre-Chorus - Chorus - Bridge - Chorus - Outro',
                'rock': 'Intro - Verse - Chorus - Verse - Chorus - Solo/Bridge - Chorus - Outro',
                'blues': 'Intro - 12-Bar Blues x3 - Solo - 12-Bar Blues - Outro',
                'jazz': 'Head (Melody) - Solo Section (improvisation over chord changes) - Head Out',
                'folk': 'Verse - Chorus - Verse - Chorus - Bridge - Chorus',
                'rap': 'Intro - Verse - Hook - Verse - Hook - Bridge - Hook - Outro'
            };

            // Song meaning database
            const songMeanings = {
                'bohemian rhapsody': {
                    title: 'Bohemian Rhapsody by Queen',
                    year: 1975,
                    artist: 'Queen',
                    album: 'A Night at the Opera',
                    meaning: "Bohemian Rhapsody is often interpreted as Freddie Mercury's confessional about coming to terms with his sexuality and the guilt he felt. The song's operatic structure reflects Mercury's classical influences, while the lyrics touch on themes of existentialism and personal crisis. The 'Bismillah' section references Mercury's Zoroastrian upbringing.",
                    lyrics: {
                        'Mama, just killed a man': 'This line represents the protagonist confessing to having committed a metaphorical "murder" of his former self.',
                        'Bismillah! No, we will not let you go': 'References the Islamic phrase meaning "in the name of God," possibly representing societal or religious judgment.'
                    },
                    trivia: 'The song was recorded in three different studios and features over 180 vocal overdubs.'
                },
                'hotel california': {
                    title: 'Hotel California by Eagles',
                    year: 1976,
                    artist: 'Eagles',
                    album: 'Hotel California',
                    meaning: "The song is often interpreted as a commentary on the excesses of American culture and the dark side of the American Dream. The hotel serves as a metaphor for hedonism, addiction, and the music industry itself. The famous line 'You can check out any time you like, but you can never leave' suggests the inescapable nature of fame and addiction.",
                    lyrics: {
                        'Warm smell of colitas, rising up through the air': 'Colitas refers to the bud of the cannabis plant, hinting at drug use.',
                        'They stab it with their steely knives, but they just can\'t kill the beast': 'Represents the band\'s struggle with the music industry and their own demons.'
                    },
                    trivia: 'The song won the 1977 Grammy Award for Record of the Year.'
                },
                'imagine': {
                    title: 'Imagine by John Lennon',
                    year: 1971,
                    artist: 'John Lennon',
                    album: 'Imagine',
                    meaning: "The song presents Lennon's vision of a peaceful world without religious divisions, national borders, or material possessions. It's considered an anthem for peace and unity, though some have criticized it for promoting communism due to its lyrics about no possessions.",
                    lyrics: {
                        'Imagine there\'s no heaven, it\'s easy if you try': 'Suggests a world without religious divisions.',
                        'No need for greed or hunger, a brotherhood of man': 'Expresses hope for equality and an end to human suffering.'
                    },
                    trivia: 'Rolling Stone ranked it the third greatest song of all time.'
                },
                'smells like teen spirit': {
                    title: 'Smells Like Teen Spirit by Nirvana',
                    year: 1991,
                    artist: 'Nirvana',
                    album: 'Nevermind',
                    meaning: "The song is often interpreted as an anthem for the disaffected youth of Generation X. The seemingly nonsensical lyrics were intentionally written to be abstract, with Kurt Cobain aiming to write the 'ultimate pop song' by using conflicting imagery and a catchy melody to mask the song's darker themes of apathy and disconnection.",
                    lyrics: {
                        'With the lights out, it\'s less dangerous': 'Suggests that truth is easier to see in darkness or when societal expectations are removed.',
                        'Here we are now, entertain us': 'A commentary on the passive, media-saturated culture of the 1990s.'
                    },
                    trivia: 'The title came from a phrase Kurt Cobain\'s friend Kathleen Hanna wrote on his wall: "Kurt smells like Teen Spirit" - a reference to the deodorant.'
                },
                'like a rolling stone': {
                    title: 'Like a Rolling Stone by Bob Dylan',
                    year: 1965,
                    artist: 'Bob Dylan',
                    album: 'Highway 61 Revisited',
                    meaning: "The song is a scathing critique of wealth, privilege, and the fall from grace. It's directed at a once-wealthy woman who has lost everything and must now fend for herself. The song captures the cultural shifts of the 1960s and the decline of the American aristocracy.",
                    lyrics: {
                        'How does it feel, to be on your own, with no direction home': 'A powerful question about isolation and loss of identity.',
                        'You never turned around to see the frowns on the jugglers and the clowns': 'Suggests the subject was too self-absorbed to notice the suffering of others.'
                    },
                    trivia: 'Rolling Stone magazine ranked it the greatest song of all time in 2004 and again in 2011.'
                }
            };

            // Tab database
            const songTabs = {
                'wonderwall': {
                    title: 'Wonderwall by Oasis',
                    tuning: 'Standard (EADGBE)',
                    capo: '2nd fret',
                    difficulty: 'Beginner',
                    chords: ['Em7', 'G', 'D', 'A7sus4'],
                    progression: 'Em7 - G - D - A7sus4 (repeats throughout the song)',
                    strumming: 'D D U U D U (down, down, up, up, down, up)',
                    tab: `e|-----0---3---2---0-----|
B|-----0---0---3---0-----|
G|-----0---0---2---0-----|
D|-----2---0---0---2-----|
A|-----2---2---0---0-----|
E|-----0---3---2---0-----|`,
                    tips: 'Use a capo on the 2nd fret to match the original recording. The strumming pattern is crucial for the right feel.'
                },
                'wish you were here': {
                    title: 'Wish You Were Here by Pink Floyd',
                    tuning: 'Standard (EADGBE)',
                    capo: 'None',
                    difficulty: 'Intermediate',
                    chords: ['C', 'D', 'Am', 'G', 'Em'],
                    progression: 'C - D - Am - G (verse)',
                    strumming: 'Arpeggiated picking pattern',
                    tab: `e|-----3-----3-----0-----0-----0-----|
B|-----3-----3-----1-----0-----0-----|
G|-----0-----0-----2-----0-----0-----|
D|-----0-----0-----2-----0-----2-----|
A|-----2-----0-----0-----2-----2-----|
E|--3-----3-----0-----3-----0-----|`,
                    tips: 'Focus on the fingerpicking pattern. The song is played with a light touch and plenty of sustain.'
                },
                'stairway to heaven': {
                    title: 'Stairway to Heaven by Led Zeppelin',
                    tuning: 'Standard (EADGBE)',
                    capo: 'None',
                    difficulty: 'Advanced',
                    chords: ['Am', 'C', 'G', 'F'],
                    progression: 'Am - C - G - F (main progression)',
                    tab: `e|-------5-7-----7-|-8-----8-2-----2-|-0---------0-----|-------5-7-----7-|
B|-----5-----5-----5-----|-----------------|-----------------|-----5-----5-----|
G|---5---------5-----5---|-----------------|-----0-2-4-2-0---|---5---------5---|
D|-----------------------|-----0-2-4-2-0---|-----------------|-----------------|
A|-3---------------------|-----------------|-----------------|-3---------------|
E|-----------------------|-----------------|-----------------|-----------------|`,
                    tips: 'This is the iconic opening riff. The song builds in complexity, so take it slow and focus on clean finger placement.'
                },
                'sweet child o\'mine': {
                    title: 'Sweet Child O\'Mine by Guns N\' Roses',
                    tuning: 'Standard (EADGBE)',
                    capo: 'None',
                    difficulty: 'Intermediate',
                    chords: ['D', 'C', 'G'],
                    progression: 'D - C - G (verse)',
                    tab: `e|-----------------|-----------------|-----------------|-----------------|
B|-----------------|-----------------|-----------------|-----------------|
G|-----------------|-----------------|-----------------|-----------------|
D|-----4-4-6-6-4---|-----2-2-4-4-2---|-----------------|-----------------|
A|---4-4-4-4-4-4-4-|---2-2-2-2-2-2-2-|-----3-3-5-5-3---|-----------------|
E|-2-2-2-2-2-2-2-2-|-0-0-0-0-0-0-0-0-|---3-3-3-3-3-3-3-|-0-0-0-0-0-0-0-0-|`,
                    tips: 'The intro riff is one of the most famous in rock history. Use alternate picking and focus on the timing.'
                },
                'blackbird': {
                    title: 'Blackbird by The Beatles',
                    tuning: 'Standard (EADGBE)',
                    capo: 'None',
                    difficulty: 'Advanced',
                    chords: ['G', 'A', 'F#m', 'Bm', 'Em'],
                    progression: 'G - A - F#m - Bm - Em (verse)',
                    tab: `e|-----------------|-----------------|-----------------|
B|-----3-----3-----|-----3-----3-----|-----3-----3-----|
G|-----0h2---0h2---|-----0h2---0h2---|-----0h2---0h2---|
D|-----2-----2-----|-----2-----2-----|-----2-----2-----|
A|-----------------|-----------------|-----------------|
E|--3-----3-----3--|--2-----2-----2--|--0-----0-----0--|`,
                    tips: 'This song uses a complex fingerpicking pattern. Practice the right hand pattern slowly before adding the left hand.'
                }
            };

            // Function to generate a tab based on parameters
            function generateTab(genre, key = 'C', difficulty = 'beginner') {
                const progressions = commonProgressions[genre] || commonProgressions['pop'];
                const tab = progressions.find(p => typeof p === 'string' && p.includes('\n'));
                const chordProgression = progressions.find(p => typeof p === 'string' && p.includes('I'));
                
                return {
                    tab: tab || 'e|-----------------|\nB|-----------------|\nG|-----------------|\nD|-----------------|\nA|-----------------|\nE|-----------------|',
                    progression: chordProgression || 'I - V - vi - IV',
                    tips: `This is a common ${genre} pattern. Try playing it with a ${difficulty} strumming pattern.`
                };
            }

            // Function to analyze lyrics
            function analyzeLyrics(lyrics) {
                // Simple sentiment analysis
                const positiveWords = ['love', 'happy', 'joy', 'peace', 'smile', 'laugh', 'beautiful'];
                const negativeWords = ['hate', 'sad', 'cry', 'pain', 'tears', 'alone', 'die', 'death'];
                
                const words = lyrics.toLowerCase().split(/\s+/);
                const wordCount = words.length;
                const uniqueWords = [...new Set(words)].length;
                
                let positiveCount = 0;
                let negativeCount = 0;
                
                words.forEach(word => {
                    if (positiveWords.includes(word)) positiveCount++;
                    if (negativeWords.includes(word)) negativeCount++;
                });
                
                const sentiment = positiveCount > negativeCount ? 'positive' : 
                                negativeCount > positiveCount ? 'negative' : 'neutral';
                
                return {
                    wordCount,
                    uniqueWords,
                    sentiment,
                    positiveWords: positiveCount,
                    negativeWords: negativeCount,
                    lexicalDiversity: (uniqueWords / wordCount * 100).toFixed(1) + '%'
                };
            }

            // Language codes for translation (11 languages including English)
            const languageData = {
                'english': { code: 'en', name: 'English', native: 'English' },
                'spanish': { code: 'es', name: 'Spanish', native: 'Espa√±ol' },
                'french': { code: 'fr', name: 'French', native: 'Fran√ßais' },
                'german': { code: 'de', name: 'German', native: 'Deutsch' },
                'italian': { code: 'it', name: 'Italian', native: 'Italiano' },
                'portuguese': { code: 'pt', name: 'Portuguese', native: 'Portugu√™s' },
                'russian': { code: 'ru', name: 'Russian', native: '–†—É—Å—Å–∫–∏–π' },
                'japanese': { code: 'ja', name: 'Japanese', native: 'Êó•Êú¨Ë™û' },
                'korean': { code: 'ko', name: 'Korean', native: 'ÌïúÍµ≠Ïñ¥' },
                'chinese': { code: 'zh', name: 'Chinese', native: '‰∏≠Êñá' },
                'hindi': { code: 'hi', name: 'Hindi', native: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' }
            };
            
            // Function to detect if a message is a translation request
            function isTranslationRequest(message) {
                const lowerMsg = message.toLowerCase();
                
                return lowerMsg.includes('translate') || 
                       lowerMsg.startsWith('how to say') ||
                       lowerMsg.startsWith('what is') && (lowerMsg.includes(' in ') || lowerMsg.includes(' en ')) ||
                       Object.keys(languageData).some(lang => 
                           lowerMsg.includes(` ${lang} `) || 
                           lowerMsg.endsWith(` ${lang}`) ||
                           lowerMsg.includes(` ${languageData[lang].native.toLowerCase()} `) ||
                           lowerMsg.endsWith(` ${languageData[lang].native.toLowerCase()}`)
                       );
            }
            
            // Function to handle translation requests with golden theme
            function handleTranslation(message) {
                const lowerMsg = message.toLowerCase();
                
                // Check for different translation request formats
                let textToTranslate = '';
                let targetLanguage = '';
                
                // Format 1: "Translate [text] to [language]"
                let match = message.match(/translate\s+['"](.*?)['"]\s+to\s+(\w+)/i) || 
                           message.match(/translate\s+(.*?)\s+to\s+(\w+)/i);
                
                // Format 2: "How do you say [text] in [language]"
                if (!match) {
                    match = message.match(/how\s+(?:to\s+)?(?:say|translate)\s+['"](.*?)['"]\s+in\s+(\w+)/i) || 
                           message.match(/what\s+is\s+['"](.*?)['"]\s+in\s+(\w+)/i);
                }
                
                // Format 3: "[text] in [language]"
                if (!match) {
                    match = message.match(/['"](.*?)['"]\s+in\s+(\w+)/i);
                }
                
                if (match) {
                    textToTranslate = match[1].trim();
                    targetLanguage = match[2].trim().toLowerCase();
                } else {
                    // Try to extract language from message
                    for (const [lang, data] of Object.entries(languageData)) {
                        if (lowerMsg.includes(' ' + lang + ' ') || lowerMsg.endsWith(' ' + lang)) {
                            targetLanguage = lang;
                            // Try to get text from quotes
                            const quoted = message.match(/['"](.*?)['"]/);
                            if (quoted) {
                                textToTranslate = quoted[1];
                            } else {
                                // Get text before the language
                                const langIndex = lowerMsg.indexOf(lang);
                                if (langIndex > 0) {
                                    textToTranslate = message.substring(0, langIndex).replace(/^(translate|how to say|what is|in|to)\s+/i, '').trim();
                                }
                            }
                            break;
                        }
                    }
                }
                
                if (!textToTranslate) {
                    // Try to use previous message as text to translate
                    if (chats[currentChatId]?.messages?.length > 1) {
                        const prevMsg = chats[currentChatId].messages[chats[currentChatId].messages.length - 2];
                        if (prevMsg.sender === 'user') {
                            textToTranslate = prevMsg.content;
                        }
                    }
                }
                
                if (!textToTranslate) {
                    const supportedLangs = Object.values(languageData).map(l => l.name).join(', ');
                    return `I can help translate text between these languages: ${supportedLangs}.\n\n` +
                           'Try formats like:\n' +
                           '- "Translate \'Hello\' to Spanish"\n' +
                           '- "How do you say \'Thank you\' in French?"\n' +
                           '- "What is \'Good morning\' in Japanese?";';
                }
                
                let textToTranslate = parts[0].trim();
                let targetLanguage = parts[1].trim().toLowerCase();
                
                // If the format is 'How do you say X in Y?'
                if (lowerMsg.startsWith('how do you say')) {
                    const match = message.match(/how do you say ['"](.*?)['"] in (\w+)/i);
                    if (match) {
                        textToTranslate = match[1];
                        targetLanguage = match[2];
                    }
                }
                
                // If no text to translate, try to find lyrics in quotes
                if (!textToTranslate) {
                    const quotedText = message.match(/['"](.*?)['"]/);
                    if (quotedText) {
                        textToTranslate = quotedText[1];
                    } else if (chats[currentChatId].messages.length > 1) {
                        // Try to use the previous message as the text to translate
                        const prevMessage = chats[currentChatId].messages[chats[currentChatId].messages.length - 2];
                        if (prevMessage.sender === 'user') {
                            textToTranslate = prevMessage.content;
                        }
                    }
                }
                
                if (!textToTranslate) {
                    return "I couldn't find any text to translate. Please provide the text you'd like to translate in quotes, like this: 'Translate \"Hello\" to Spanish'";
                }
                
                // Find the target language
                let targetLang = null;
                
                // First check exact matches
                if (languageData[targetLanguage]) {
                    targetLang = languageData[targetLanguage];
                } else {
                    // Check language names and native names
                    for (const [lang, data] of Object.entries(languageData)) {
                        if (targetLanguage === lang || 
                            targetLanguage === data.name.toLowerCase() || 
                            targetLanguage === data.native.toLowerCase()) {
                            targetLang = data;
                            break;
                        }
                        
                        // Check partial matches
                        if (lang.includes(targetLanguage) || 
                            data.name.toLowerCase().includes(targetLanguage) || 
                            data.native.toLowerCase().includes(targetLanguage)) {
                            targetLang = data;
                            break;
                        }
                    }
                }
                
                if (!targetLang) {
                    const supportedLangs = Object.values(languageData).map(l => l.name).join(', ');
                    return `I couldn't recognize the language "${targetLanguage}". I can translate to: ${supportedLangs}`;
                }
                
                // In a real app, you would call a translation API here
                // For now, we'll simulate a translation with a placeholder
                const translatedText = `[${targetLang.name} (${targetLang.native}) translation of: "${textToTranslate}"]`;
                
                // Create golden-themed response
                return `üåç **${targetLang.name} (${targetLang.native})**\n` +
                       `üî§ **Original:** ${textToTranslate}\n` +
                       `‚ú® **Translated:** ${translatedText}\n\n` +
                       'üí° *Note: This is a simulated translation. For accurate translations, consider using a professional translation service.*';
            }
            
            // Enhanced music knowledge base
            function getBotResponse(userMessage) {
                // Check for translation requests first
                if (isTranslationRequest(userMessage)) {
                    return handleTranslation(userMessage);
                }
                const lowerMessage = userMessage.toLowerCase();
                
                // Check if the message is music-related
                const musicKeywords = [
                    'music', 'song', 'band', 'artist', 'guitar', 'piano', 'drum', 'bass', 'violin',
                    'chord', 'scale', 'note', 'melody', 'harmony', 'rhythm', 'tab', 'lyric', 'verse',
                    'chorus', 'bridge', 'riff', 'solo', 'genre', 'jazz', 'rock', 'pop', 'classical',
                    'blues', 'metal', 'folk', 'country', 'hip hop', 'rap', 'r&b', 'edm', 'electronic',
                    'key', 'tempo', 'beat', 'measure', 'time signature', 'arpeggio', 'tuning', 'capo',
                    'pick', 'strum', 'pluck', 'bend', 'vibrato', 'slide', 'hammer', 'pull', 'tremolo',
                    'harmonics', 'palm mute', 'fingerstyle', 'pick', 'plectrum', 'album', 'lyrics',
                    'meaning', 'interpretation', 'analysis', 'songwriting', 'compose', 'arrangement',
                    'progression', 'chord progression', 'riff', 'lick', 'solo', 'improvise', 'jam',
                    'write', 'create', 'make', 'play', 'sing', 'vocal', 'bassline', 'drumbeat', 'beat',
                    'harmonize', 'transpose', 'modulate', 'key change', 'bridge', 'verse', 'chorus',
                    'pre-chorus', 'post-chorus', 'intro', 'outro', 'breakdown', 'fill', 'groove',
                    'acoustic', 'electric', 'amplifier', 'pedal', 'effects', 'reverb', 'delay', 'chorus',
                    'flanger', 'phaser', 'distortion', 'overdrive', 'fuzz', 'wah', 'looper', 'tuner',
                    'metronome', 'tempo', 'time signature', 'time', 'signature', 'time signature',
                    'time signature', 'time signature', 'time signature', 'time signature'
                ];
                
                const isMusicRelated = musicKeywords.some(keyword => lowerMessage.includes(keyword));
                
                if (!isMusicRelated) {
                    return "I'm sorry, but I'm designed to assist with music-related topics only. " +
                           "Please ask me about music theory, song meanings, guitar tabs, or anything else music-related!";
                }
                
                // Handle song meaning and analysis requests
                if (lowerMessage.includes('meaning of') || 
                    lowerMessage.includes('what does') || 
                    lowerMessage.includes('analyze') ||
                    lowerMessage.includes('interpretation') ||
                    lowerMessage.includes('lyrics to')) {
                    
                    // Extract song title if provided
                    const songMatch = userMessage.match(/(?:meaning of|what does|analyze|interpretation of|lyrics to) ['"](.*?)['"]/i) ||
                                    userMessage.match(/(?:what is|explain) (?:the )?(?:meaning|lyrics?) of (.*?)(?:\?|$)/i);
                    
                    if (songMatch && songMatch[1]) {
                        const songTitle = songMatch[1].trim();
                        return `I can help analyze "${songTitle}". While I don't have every song's lyrics memorized, I can help you understand common themes and song structures. Could you share some lyrics or specific aspects you'd like me to analyze?`;
                    } else if (lowerMessage.includes('lyrics') && !lowerMessage.includes('meaning')) {
                        return "I can help you find and analyze song lyrics. Please provide the song title and artist, or share the specific lyrics you'd like me to look at.";
                    }
                    
                    return "I can help analyze song meanings and lyrics. Could you tell me which song you're curious about? " +
                           "For example: 'What is the meaning of Bohemian Rhapsody?' or 'Analyze the lyrics to Hotel California'.";
                }
                
                // Handle tab and chord requests
                if (lowerMessage.includes('tab') || 
                    lowerMessage.includes('chord') || 
                    lowerMessage.includes('how to play') ||
                    lowerMessage.includes('guitar part') ||
                    lowerMessage.includes('riff') ||
                    lowerMessage.includes('lick')) {
                    
                    // Try to extract song title and artist
                    const songMatch = userMessage.match(/(?:how to play|tabs?|chords? for) ['"](.*?)['"]/i) ||
                                    userMessage.match(/(?:show me|give me) (?:the )?(?:tabs?|chords?) (?:for|to) (.*?)(?:\?|$)/i);
                    
                    if (songMatch && songMatch[1]) {
                        const songTitle = songMatch[1].trim();
                        const genreMatch = Object.keys(commonProgressions).find(g => lowerMessage.includes(g));
                        const genre = genreMatch || 'rock';
                        
                        const difficulty = lowerMessage.includes('beginner') ? 'beginner' :
                                         lowerMessage.includes('advanced') ? 'advanced' :
                                         lowerMessage.includes('intermediate') ? 'intermediate' : 'beginner';
                        
                        const { tab, progression, tips } = generateTab(genre, 'C', difficulty);
                        
                        let response = `**${songTitle}**\n`;
                        response += `*Genre: ${genre.charAt(0).toUpperCase() + genre.slice(1)}*\n`;
                        response += `*Difficulty: ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}*\n\n`;
                        
                        response += `**Common Chord Progression:** ${progression}\n\n`;
                        response += '**Tab:**\n```\n' + tab + '\n```\n\n';
                        response += `**Tips:** ${tips}\n\n`;
                        response += "*Note: This is a generated tab based on common patterns. For the exact tab, you might want to check official sources.*";
                        
                        return response;
                    } else {
                        const genreList = Object.keys(commonProgressions).join(', ');
                        return `I can help you with tabs and chords. Please specify the song you're interested in, and optionally the genre or difficulty level.\n\n` +
                               `Available genres: ${genreList}\n\n` +
                               `Example: 'Show me tabs for Sweet Child O' Mine' or 'Easy guitar chords for Wonderwall'`;
                    }
                }
                
                // Music theory and songwriting help
                if (lowerMessage.includes('circle of fifths') || lowerMessage.includes('circle of fourths')) {
                    return "The Circle of Fifths is a visual representation of the relationships among the 12 tones of the chromatic scale. " +
                           "Moving clockwise around the circle, each note is a perfect fifth above the previous one. " +
                           "It's a fundamental tool for understanding key signatures, chord progressions, and modulation in music theory.\n\n" +
                           "**Practical Uses:**\n" +
                           "- Finding relative major/minor keys\n" +
                           "- Building chord progressions\n" +
                           "- Modulating between keys\n" +
                           "- Understanding key signatures";
                }
                
                if (lowerMessage.includes('major scale') || lowerMessage.includes('minor scale')) {
                    const scaleType = lowerMessage.includes('major') ? 'Major' : 'minor';
                    return `**${scaleType} Scale**\n\n` +
                           `The ${scaleType} scale is a diatonic scale with a specific pattern of whole and half steps.\n\n` +
                           `**Pattern:** ${scaleType === 'Major' ? 'W-W-H-W-W-W-H' : 'W-H-W-W-H-W-W'} (W = whole step, H = half step)\n\n` +
                           `**Example in C${scaleType === 'Major' ? '' : 'm'}:** ` +
                           (scaleType === 'Major' 
                               ? 'C - D - E - F - G - A - B - C'
                               : 'C - D - Eb - F - G - Ab - Bb - C') + 
                           `\n\n` +
                           `**Characteristics:**\n` +
                           `- ${scaleType === 'Major' ? 'Bright, happy sound' : 'Darker, more somber mood'}\n` +
                           `- Foundation of Western music theory\n` +
                           `- Used in countless songs across all genres`;
                }
                
                // Songwriting and composition
                if (lowerMessage.includes('write a song') || 
                    lowerMessage.includes('compose') || 
                    lowerMessage.includes('song structure')) {
                    
                    const genreMatch = Object.keys(songStructures).find(g => lowerMessage.includes(g));
                    const genre = genreMatch || 'pop';
                    
                    return `**${genre.charAt(0).toUpperCase() + genre.slice(1)} Song Structure**\n\n` +
                           `A typical ${genre} song follows this structure:\n\n` +
                           `**${songStructures[genre]}**\n\n` +
                           `**Common Chord Progressions in ${genre}:**\n` +
                           commonProgressions[genre].filter(p => typeof p === 'string' && p.includes('-')).join('\n') +
                           `\n\n` +
                           `**Tips for Writing a ${genre} Song:**\n` +
                           `1. Start with a strong ${genre === 'pop' ? 'hook' : genre === 'rock' ? 'riff' : 'melody'}\n` +
                           `2. Keep your chord progressions simple and memorable\n` +
                           `3. Focus on a clear verse-chorus structure\n` +
                           `4. Add variation in the bridge or middle eight\n` +
                           `5. Consider the emotional arc of your song`;
                }
                
                // Tab/chord responses
                if (lowerMessage.includes('tab') || lowerMessage.includes('chord') || lowerMessage.includes('how to play')) {
                    const songMatch = userMessage.match(/how to play (.*?)(\?|$)/i) || 
                                    userMessage.match(/(?:tab|chord)s? for (.*?)(\?|$)/i);
                    
                    if (songMatch && songMatch[1]) {
                        const song = songMatch[1].trim().toLowerCase();
                        const songTabsList = Object.keys(songTabs).join(', ');
                        
                        return `I can help you with tabs for "${song}". Here's what I can show you directly:\n\n` +
                               `I currently have tabs for: ${songTabsList}\n\n` +
                               "Would you like me to show you one of these songs? For example: 'Show me tabs for Wonderwall' or 'How to play Stairway to Heaven'.";
                    }
                    
                    return "I can help you with guitar tabs and chords. Could you tell me which song you're interested in? " +
                           "For example: 'Show me tabs for Wonderwall' or 'Chords for Hotel California'.";
                }
                
                // Song meaning/lyrics
                if (lowerMessage.includes('meaning of') || lowerMessage.includes('what does') || 
                    lowerMessage.includes('lyrics to') || lowerMessage.includes('lyric meaning') ||
                    lowerMessage.includes('what is the meaning of')) {
                    
                    const songMatch = userMessage.match(/(?:meaning of|what does|lyrics? to) ['"](.*?)['"]/i) ||
                                    userMessage.match(/(?:what is|explain) (?:the )?(?:meaning|lyrics?) of (.*?)(?:\?|$)/i);
                    
                    if (songMatch && songMatch[1]) {
                        const song = songMatch[1].trim().toLowerCase();
                        const songList = Object.keys(songMeanings).join(', ');
                        
                        return `I can analyze the meaning of "${song}" for you. I currently have detailed analyses for these songs:\n\n` +
                               `${songList}\n\n` +
                               `Would you like me to analyze one of these songs? For example: 'Tell me about Bohemian Rhapsody' or 'What is the meaning of Imagine'`;
                    }
                    
                    return "I can help analyze song meanings and lyrics. Could you tell me which song you're curious about? " +
                           "For example: 'What is the meaning of Bohemian Rhapsody?' or 'Explain the lyrics to Hotel California'.";
                }
                
                // Practice tips
                if (lowerMessage.includes('practice') || lowerMessage.includes('exercise') || 
                    lowerMessage.includes('routine') || lowerMessage.includes('how to improve')) {
                    
                    if (lowerMessage.includes('beginner')) {
                        return "**Beginner Practice Routine (30 minutes):**\n\n" +
                               "1. **Warm-up (5 min)**: Simple finger exercises and chromatic runs\n" +
                               "2. **Chords (10 min)**: Practice transitioning between G, C, D, and E minor\n" +
                               "3. **Strumming (5 min)**: Work on basic down-up strumming patterns\n" +
                               "4. **Song Practice (10 min)**: Apply chords to a simple song\n\n" +
                               "Would you like me to suggest specific exercises for any of these areas?";
                    }
                    
                    return "I can help you create a practice routine. Could you tell me:\n" +
                           "1. Your skill level (beginner, intermediate, advanced)\n" +
                           "2. What you'd like to focus on (chords, scales, songs, etc.)\n" +
                           "3. How much time you can dedicate to practice";
                }
                
                // Default response for music-related queries
                const defaultResponses = [
                    "That's an interesting question about music! Could you provide more details so I can give you a more specific answer?",
                    "I'd be happy to help with that music topic. Could you clarify what specific aspect you're interested in?",
                    "Music is a vast subject! Could you tell me more about what you'd like to know?"
                ];
                
                return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            }

            async function handleUserInput() {
                const message = chatInput.value.trim();
                if (message === '') return;

                // Check for duplicate message
                const lastMessage = chats[currentChatId].messages[chats[currentChatId].messages.length - 1];
                if (lastMessage && lastMessage.content === message && lastMessage.sender === 'user') {
                    chatInput.value = '';
                    return; // Don't send duplicate messages
                }

                // Add user message to chat
                const userMessage = {
                    sender: 'user',
                    content: message,
                    timestamp: new Date()
                };
                
                // If this is a new chat, create a title from the first message
                if (!chats[currentChatId] || chats[currentChatId].messages.length === 0) {
                    if (!chats[currentChatId]) {
                        currentChatId = 'chat-' + Date.now();
                        chats[currentChatId] = {
                            id: currentChatId,
                            title: message.length > 30 ? message.substring(0, 30) + '...' : message,
                            messages: []
                        };
                    } else {
                        chats[currentChatId].title = message.length > 30 ? message.substring(0, 30) + '...' : message;
                    }
                    renderChatList();
                }
                
                chats[currentChatId].messages.push(userMessage);
                renderChat(currentChatId);
                
                // Show typing indicator
                showTypingIndicator(true);
                
                // Clear input
                chatInput.value = '';
                
                // Simulate bot response after a delay
                setTimeout(() => {
                    showTypingIndicator(false);
                    const botResponse = getBotResponse(message);
                    const botMessage = {
                        sender: 'bot',
                        content: botResponse,
                        timestamp: new Date()
                    };
                    chats[currentChatId].messages.push(botMessage);
                    renderChat(currentChatId);
                    saveChats();
                }, 1000);
                
                // Save chats after user message
                saveChats();
            }
            
            // Initialize the chat when the page loads
            initChat();
        });
    </script>
    <script src="auth.js"></script>
    <script src="script.js"></script>
</body>
</html>
